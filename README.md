# Grafana authentication via Keycloak on Kind K8S running on Docker Desktop on Windows (+ WSL2)

## Setup of HOSTS file on both Windows and WSL2 side

### Windows
The line referencing Keycloak, Grafana etc. should be added
```
# localhost name resolution is handled within DNS itself.
#       127.0.0.1       localhost
#       ::1             localhost
127.0.0.1 kubernetes.docker.internal
192.168.1.6 keycloak.docker.internal grafana.docker.internal alertmanager.docker.internal prometheus.docker.internal
# Added by Docker Desktop
192.168.1.6 host.docker.internal
192.168.1.6 gateway.docker.internal
# To allow the same kube context to work on the host and the container:
127.0.0.1 kubernetes.docker.internal
```

### Linux
Same additional line
```
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateHosts = false
127.0.0.1       localhost
127.0.1.1       DESKTOP-NL6I2OD.        DESKTOP-NL6I2OD
127.0.0.1       kubernetes.docker.internal
192.168.1.6     keycloak.docker.internal grafana.docker.internal alertmanager.docker.internal prometheus.docker.internal
192.168.1.6     host.docker.internal
192.168.1.6     gateway.docker.internal
127.0.0.1       kubernetes.docker.internal
```

## Creating Kind single-node cluster, ready for an Ingress Controller deployment
```
ferdi@DESKTOP-NL6I2OD:~/kube-grafana-keycloak$ kind create cluster --config 00-kind.yml 
Creating cluster "kind" ...
 ‚úì Ensuring node image (kindest/node:v1.25.0) üñº 
 ‚úì Preparing nodes üì¶  
 ‚úì Writing configuration üìú 
 ‚úì Starting control-plane üïπÔ∏è 
 ‚úì Installing CNI üîå 
 ‚úì Installing StorageClass üíæ 
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Have a nice day! üëã
```

## Adding host entry on CoreDNS' ConfigMap
We should add these lines inside **coredns** ConfigMap, on **kube-system** Namespace (complete example in *01-coredns.yml*) to allow the same name resolution inside the K8S cluster, too
```
        hosts {
           192.168.1.6 keycloak.docker.internal grafana.docker.internal alertmanager.docker.internal prometheus.docker.internal
        }
```
Probably we don't need to do that, but just in case...
```
ferdi@DESKTOP-NL6I2OD:~/kube-grafana-keycloak$ kubectl rollout restart -n kube-system deploy/coredns
deployment.apps/coredns restarted
```

## Installing NGINX Ingress Controller on NodePort
This one is straightforward, by leveraging an already customized YAML (Kind-compatible); I've downloaded it and saved as **02-ingress-nginx-kind-deploy.yml**
```
ferdi@DESKTOP-NL6I2OD:~/kube-grafana-keycloak$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
namespace/ingress-nginx created
serviceaccount/ingress-nginx created
serviceaccount/ingress-nginx-admission created
role.rbac.authorization.k8s.io/ingress-nginx created
role.rbac.authorization.k8s.io/ingress-nginx-admission created
clusterrole.rbac.authorization.k8s.io/ingress-nginx created
clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created
rolebinding.rbac.authorization.k8s.io/ingress-nginx created
rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created
clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
configmap/ingress-nginx-controller created
service/ingress-nginx-controller created
service/ingress-nginx-controller-admission created
deployment.apps/ingress-nginx-controller created
job.batch/ingress-nginx-admission-create created
job.batch/ingress-nginx-admission-patch created
ingressclass.networking.k8s.io/nginx created
validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created
```

## Installing Operator Lifecycle Manager
We're not going the OLM-SDK way here, we'll stick with https://github.com/operator-framework/operator-lifecycle-manager/releases/tag/v0.22.0 instructions
```
ferdi@DESKTOP-NL6I2OD:~/kube-grafana-keycloak$ curl -L https://github.com/operator-framework/operator-lifecycle-manager/releases/download/v0.22.0/install.sh -o 03-olm-install.sh
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100  1886  100  1886    0     0   3361      0 --:--:-- --:--:-- --:--:--  3361
ferdi@DESKTOP-NL6I2OD:~/kube-grafana-keycloak$ chmod +x 03-olm-install.sh 
ferdi@DESKTOP-NL6I2OD:~/kube-grafana-keycloak$ ./03-olm-install.sh v0.22.0
customresourcedefinition.apiextensions.k8s.io/catalogsources.operators.coreos.com created
customresourcedefinition.apiextensions.k8s.io/clusterserviceversions.operators.coreos.com created
customresourcedefinition.apiextensions.k8s.io/installplans.operators.coreos.com created
customresourcedefinition.apiextensions.k8s.io/olmconfigs.operators.coreos.com created
customresourcedefinition.apiextensions.k8s.io/operatorconditions.operators.coreos.com created
customresourcedefinition.apiextensions.k8s.io/operatorgroups.operators.coreos.com created
customresourcedefinition.apiextensions.k8s.io/operators.operators.coreos.com created
customresourcedefinition.apiextensions.k8s.io/subscriptions.operators.coreos.com created
customresourcedefinition.apiextensions.k8s.io/catalogsources.operators.coreos.com condition met
customresourcedefinition.apiextensions.k8s.io/clusterserviceversions.operators.coreos.com condition met
customresourcedefinition.apiextensions.k8s.io/installplans.operators.coreos.com condition met
customresourcedefinition.apiextensions.k8s.io/olmconfigs.operators.coreos.com condition met
customresourcedefinition.apiextensions.k8s.io/operatorconditions.operators.coreos.com condition met
customresourcedefinition.apiextensions.k8s.io/operatorgroups.operators.coreos.com condition met
customresourcedefinition.apiextensions.k8s.io/operators.operators.coreos.com condition met
customresourcedefinition.apiextensions.k8s.io/subscriptions.operators.coreos.com condition met
namespace/olm created
namespace/operators created
serviceaccount/olm-operator-serviceaccount created
clusterrole.rbac.authorization.k8s.io/system:controller:operator-lifecycle-manager created
clusterrolebinding.rbac.authorization.k8s.io/olm-operator-binding-olm created
olmconfig.operators.coreos.com/cluster created
deployment.apps/olm-operator created
deployment.apps/catalog-operator created
clusterrole.rbac.authorization.k8s.io/aggregate-olm-edit created
clusterrole.rbac.authorization.k8s.io/aggregate-olm-view created
operatorgroup.operators.coreos.com/global-operators created
operatorgroup.operators.coreos.com/olm-operators created
clusterserviceversion.operators.coreos.com/packageserver created
catalogsource.operators.coreos.com/operatorhubio-catalog created
Waiting for deployment "olm-operator" rollout to finish: 0 of 1 updated replicas are available...
deployment "olm-operator" successfully rolled out
Waiting for deployment "catalog-operator" rollout to finish: 0 of 1 updated replicas are available...
deployment "catalog-operator" successfully rolled out
Package server phase: Installing
Package server phase: Succeeded
deployment "packageserver" successfully rolled out
```

## Installing Keycloak 

### Keycloak Operator
```
ferdi@DESKTOP-NL6I2OD:~/kube-grafana-keycloak$ kubectl create --save-config -f 04-keycloak-operator.yaml 
namespace/keycloak created
operatorgroup.operators.coreos.com/operatorgroup created
subscription.operators.coreos.com/keycloak-operator created
```
### Keycloak instance

